name: Build Calibrix (server + process-eng-app)

on:
  push:
    branches: [ main ]

permissions:
    contents: write

jobs:

    compute-tag-and-version:
      runs-on: ubuntu-latest
      outputs:
        app_version: ${{ steps.version.outputs.app_version }}
        tag_version: ${{ steps.version.outputs.tag_version }}

      steps:
        - name: Checkout
          uses: actions/checkout@v4
          with:
            token: ${{ secrets.PAT_FOR_WORKFLOW }} 
            fetch-depth: 0          # needed for tags

        - name: Install jq
          run: sudo apt-get update && sudo apt-get install -y jq

        - name: Read major.minor from version.json
          shell: bash
          run: |
            MAJOR=$(jq '.major' version.json)
            MINOR=$(jq '.minor' version.json)
            echo "MAJOR=$MAJOR" >> $GITHUB_ENV
            echo "MINOR=$MINOR" >> $GITHUB_ENV
            echo "BASE_VERSION=$MAJOR.$MINOR" >> $GITHUB_ENV
          
        - name: Compute next patch from git tags and cmpose app version
          id: version
          run: |
            # get last tag vBASE_VERSION.x (e.g. v1.4.23)
            LAST_TAG=$(git tag --list "v${BASE_VERSION}.*" | sort -V | tail -n 1)

            if [ -z "$LAST_TAG" ]; then
              PATCH=0
            else
              # LAST_TAG looks like v1.4.23 â†’ strip prefix and base, keep patch
              LAST_PART=${LAST_TAG#v$BASE_VERSION.}
              PATCH=$((LAST_PART + 1))
            fi

            #compose versions
            APP_VERSION="$BASE_VERSION.$PATCH.0" 
            TAG_VERSION="$BASE_VERSION.$PATCH"

            # Set output
            echo "app_version=$APP_VERSION" >> $GITHUB_OUTPUT
            echo "tag_version=$TAG_VERSION" >> $GITHUB_OUTPUT

            # Print for Debug
            echo "Building version $APP_VERSION"

    build-server:
      needs: compute-tag-and-version
      runs-on: ubuntu-latest

      steps:
        - name: Setup Node
          uses: actions/setup-node@v4
          with:
            node-version: '22'      # Calibrix node version in use

        - name: Install jq
          run: sudo apt-get update && sudo apt-get install -y jq

        - name: Checkout
          uses: actions/checkout@v4
          with:
            fetch-depth: 0

        #Update server/package.json version
        - name: Set server version
          working-directory: server
          run: |
            APP_VERSION="${{ needs.compute-tag-and-version.outputs.app_version }}"
            jq ".version = \"$APP_VERSION\"" package.json > package.tmp && mv package.tmp package.json

        #Install & build server
        - name: Install server
          working-directory: server
          run: npm ci

    build-process-eng-app:
      needs: compute-tag-and-version
      runs-on: ubuntu-latest

      steps:
        - name: Setup Node
          uses: actions/setup-node@v4
          with:
            node-version: 22

        - name: Install jq
          run: sudo apt-get update && sudo apt-get install -y jq

        - name: Checkout
          uses: actions/checkout@v4  
          with:
            fetch-depth: 0  

        #Update process-eng-app/package.json version and .env.production
        - name: Set process-eng-app version
          working-directory: process-eng-app
          run: |
            APP_VERSION="${{ needs.compute-tag-and-version.outputs.app_version }}"
            jq ".version = \"$APP_VERSION\"" package.json > package.tmp && mv package.tmp package.json
            if grep -q "^REACT_APP_CALIBRIX_WEB_FRONTEND_VERSION=" .env.production; then
              sed -i "s/^REACT_APP_CALIBRIX_WEB_FRONTEND_VERSION=.*/REACT_APP_CALIBRIX_WEB_FRONTEND_VERSION=$APP_VERSION/" .env.production;
            else
              echo "REACT_APP_CALIBRIX_WEB_FRONTEND_VERSION=$APP_VERSION" >> .env.production;
            fi

        - name: Install deps
          working-directory: process-eng-app
          run: npm ci

        - name: Build React app
          working-directory: process-eng-app
          env:
            CI: false
          run: npm run build

        - name: Package build/ as zip
          shell: bash
          run: |
            cd process-eng-app
            zip -r ../process-eng-app-build.zip build/

        #Upload as GitHub Actions artifact
        - name: Upload artifact to Actions
          uses: actions/upload-artifact@v4
          with:
            name: process-eng-app-build
            path: process-eng-app-build.zip

    build-win-operator-app:
      needs: compute-tag-and-version
      runs-on: windows-latest

      steps:

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Build Windows Desktop
        shell: pwsh
        env:
          APP_VERSION: ${{ needs.compute-tag-and-version.outputs.app_version }}
        run: |
          cd OperatorApp
          .\win-publish-release.ps1

      - name: Install Inno Setup
        run: choco install innosetup -y

      - name: Build Windows Installer
        shell: pwsh
        env:
          APP_VERSION: ${{ needs.compute-tag-and-version.outputs.app_version }}
        run: |
          cd OperatorApp
          Write-Host "APP_VERSION=$env:APP_VERSION"
          iscc /DMyAppVersion="$env:APP_VERSION" win-calibrix-install.iss

      - name: Upload OperatorApp installer
        uses: actions/upload-artifact@v4
        with:
          name: CalibrixOperatorWin
          path: OperatorApp/Output/CalibrixOperatorWin*.exe

    create-and-push-tag:
      needs: 
        - compute-tag-and-version
        - build-server
        - build-process-eng-app
        - build-win-operator-app
      runs-on: ubuntu-latest
      permissions:
        contents: write

      steps:
      
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create and push tag
        if: github.ref == 'refs/heads/main'
        env:
          TAG_VERSION: ${{ needs.compute-tag-and-version.outputs.tag_version }}
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git tag "v$TAG_VERSION"
          git push origin "v$TAG_VERSION"

    upload-artifacts:
      needs: 
        - compute-tag-and-version
        - build-process-eng-app
        - build-win-operator-app
        - create-and-push-tag
      runs-on: ubuntu-latest
      permissions:
        contents: write
  
      steps:
      
      - uses: actions/checkout@v4

      - name: Download OperatorApp installer artifact
        uses: actions/download-artifact@v4
        with:
          name: CalibrixOperatorWin
          path: OperatorApp/Output

      - name: Download process-eng-app artifact
        uses: actions/download-artifact@v4
        with:
          name: process-eng-app-build
          path: process-eng-app/output

      - name: Upload release assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.compute-tag-and-version.outputs.tag_version }}
          files: |
            OperatorApp/Output/CalibrixOperatorWin*.exe
            process-eng-app/output/process-eng-app-build.zip